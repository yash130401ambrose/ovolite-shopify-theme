{% liquid
  assign section_height = section.settings.section_height | default: 80
  assign padding_top = section.settings.padding_top | default: 40
  assign padding_bottom = section.settings.padding_bottom | default: 40
  assign overlay_color = section.settings.overlay_color | default: '#FAF7EF'
  assign bg_image = section.settings.bg_image
  assign bg_image_mobile = section.settings.bg_image_mobile | default: bg_image
  assign heading_text = section.settings.heading_text | default: 'FOR PROFESSIONAL AND HOME USE · BAKERY · HORECA · CONFECTIONERY'
  assign text_color = section.settings.text_color | default: '#000000'
  assign text_weight = section.settings.text_weight | default: 900
  assign letter_spacing = section.settings.letter_spacing | default: 0
  assign line_height = section.settings.line_height | default: 92
  assign font_size = section.settings.font_size | default: 10
  assign parallax_strength = section.settings.parallax_strength | default: 20
  assign enable_scribble = section.settings.enable_scribble
  assign scribble_stroke = section.settings.scribble_stroke | default: '#000000'
  assign scribble_width = section.settings.scribble_width | default: 4
  assign scribble_duration = section.settings.scribble_duration | default: 1.5
  assign scribble_viewbox = section.settings.scribble_viewbox | default: '0 0 600 180'
  assign scribble_paths = section.settings.scribble_svg_paths
  assign enable_scribble_text = section.settings.enable_scribble_text
  assign scribble_text = section.settings.scribble_text | default: 'Ways of Using'
  assign scribble_font_url = section.settings.scribble_font_url
  assign scribble_font_family = section.settings.scribble_font_family | default: 'ScribbleCustom'
  assign scribble_text_size = section.settings.scribble_text_size | default: 8
  assign scribble_text_color = section.settings.scribble_text_color | default: '#000000'
  assign scribble_text_offset_x = section.settings.scribble_text_offset_x | default: -6
  assign scribble_text_offset_y = section.settings.scribble_text_offset_y | default: -8
  assign scribble_text_rotation = section.settings.scribble_text_rotation | default: -6
  assign scribble_text_stroke_width = section.settings.scribble_text_stroke_width | default: 2
  assign scribble_text_fill_after = section.settings.scribble_text_fill_after | default: true
  assign scribble_mask_id = 'cutout-scribble-mask-' | append: section.id
  assign has_bg_image = false
  if bg_image != blank
    assign has_bg_image = true
  endif

  assign heading_font_choice = section.settings.heading_font_choice | default: 'sans'
  assign heading_font_family = "'Helvetica Neue', Arial, sans-serif"
  assign heading_font_primary = 'Helvetica Neue'
  case heading_font_choice
    when 'serif'
      assign heading_font_family = "'Georgia', 'Times New Roman', serif"
      assign heading_font_primary = 'Georgia'
    when 'condensed'
      assign heading_font_family = "'Arial Narrow', 'Helvetica Neue', sans-serif"
      assign heading_font_primary = 'Arial Narrow'
    when 'mono'
      assign heading_font_family = "'Courier New', Courier, monospace"
      assign heading_font_primary = 'Courier New'
  endcase

  assign scribble_font_choice = section.settings.scribble_font_choice | default: 'script'
  assign scribble_font_stack = "'Brush Script MT', 'Segoe Script', cursive"
  assign scribble_font_primary = 'Brush Script MT'
  case scribble_font_choice
    when 'marker'
      assign scribble_font_stack = "'Marker Felt', 'Comic Sans MS', cursive"
      assign scribble_font_primary = 'Marker Felt'
    when 'serif'
      assign scribble_font_stack = "'Georgia', 'Times New Roman', serif"
      assign scribble_font_primary = 'Georgia'
    when 'sans'
      assign scribble_font_stack = "'Helvetica Neue', Arial, sans-serif"
      assign scribble_font_primary = 'Helvetica Neue'
  endcase

  if scribble_font_url != blank
    assign scribble_font_stack = "'" | append: scribble_font_family | append: "', 'Brush Script MT', 'Segoe Script', cursive"
    assign scribble_font_primary = scribble_font_family
  endif
%}

<section id="cutout-hero-{{ section.id }}" class="cutout-hero" style="--overlay: {{ overlay_color }}; --text-color: {{ text_color }}; --weight: {{ text_weight }}; --letter: {{ letter_spacing }}px; --line: {{ line_height }}px; --font-size: {{ font_size }}vw; --parallax: {{ parallax_strength }}; --scribble-stroke: {{ scribble_stroke }}; --scribble-width: {{ scribble_width }}; --scribble-duration: {{ scribble_duration }}s; --vh: {{ section_height }}vh; --pt: {{ padding_top }}px; --pb: {{ padding_bottom }}px; --scribble-text-size: {{ scribble_text_size }}vw; --scribble-text-color: {{ scribble_text_color }}; --scribble-text-offset-x: {{ scribble_text_offset_x }}vw; --scribble-text-offset-y: {{ scribble_text_offset_y }}vw; --scribble-text-rotation: {{ scribble_text_rotation }}deg; --scribble-subtitle-stroke-width: {{ scribble_text_stroke_width }}px; --heading-font-family: {{ heading_font_family }}; --scribble-font-stack: {{ scribble_font_stack }};">
  {% if enable_scribble_text and scribble_font_url != blank %}
  <style>
    @font-face {
      font-family: '{{ scribble_font_family }}';
      src: url('{{ scribble_font_url }}') format('woff2');
      font-display: swap;
    }
  </style>
  {% endif %}
  <div class="cutout-hero__bg">
    {% if bg_image %}
      <picture>
        {% if bg_image_mobile %}
          <source media="(max-width: 768px)" srcset="{{ bg_image_mobile | image_url: width: 1200 }} 1x, {{ bg_image_mobile | image_url: width: 2000 }} 2x">
        {% endif %}
        <img src="{{ bg_image | image_url: width: 2000 }}" alt="" loading="lazy" />
      </picture>
    {% endif %}
  </div>
  <div class="cutout-hero__overlay"></div>
  <div class="cutout-hero__content">
    {% if enable_scribble %}
      <div class="cutout-hero__scribble" aria-hidden="true">
        <svg viewBox="{{ scribble_viewbox }}" fill="none" xmlns="http://www.w3.org/2000/svg">
          {% if scribble_paths != blank %}
            {{ scribble_paths | raw }}
          {% else %}
            <path d="M15 120 C60 10, 140 200, 200 40"/>
            <path d="M210 60 C260 -20, 340 200, 390 60"/>
            <path d="M410 90 C470 -10, 560 220, 590 40"/>
          {% endif %}
        </svg>
      </div>
    {% endif %}

    <div class="cutout-hero__titleWrap">
      {% if enable_scribble_text %}
        <div class="cutout-hero__subtitle">
          <span class="cutout-hero__subtitle-hidden">{{ scribble_text }}</span>
          <svg viewBox="0 0 1000 220" preserveAspectRatio="xMinYMin meet" role="presentation">
            <defs>
              <mask id="{{ scribble_mask_id }}" maskUnits="userSpaceOnUse">
                <rect class="cutout-hero__subtitle-mask" x="0" y="0" width="0" height="220" fill="#fff"></rect>
              </mask>
            </defs>
            <text
              class="cutout-hero__subtitle-text"
              x="0"
              y="160"
              font-family="{{ scribble_font_primary }}"
              stroke="currentColor"
              fill="currentColor"
              fill-opacity="1"
              vector-effect="non-scaling-stroke"
              stroke-width="var(--scribble-subtitle-stroke-width)"
              mask="url(#{{ scribble_mask_id }})"
            >
              {{ scribble_text }}
            </text>
          </svg>
        </div>
      {% endif %}
      <h1 class="cutout-hero__title{% if has_bg_image %} cutout-hero__title--masked{% endif %}">{{ heading_text }}</h1>
    </div>
  </div>
</section>

<style>
  #cutout-hero-{{ section.id }} {
    position: relative;
    width: 100%;
    min-height: 320px;
    height: var(--vh);
    padding-top: var(--pt);
    padding-bottom: var(--pb);
    overflow: hidden;
    background: var(--overlay);
  }
  #cutout-hero-{{ section.id }} .cutout-hero__bg { position: absolute; inset: 0; z-index: 0; overflow: hidden; }
  #cutout-hero-{{ section.id }} .cutout-hero__bg img { width: 100%; height: 100%; object-fit: cover; transform: translateY(0); will-change: transform; }
  #cutout-hero-{{ section.id }} .cutout-hero__overlay { position: absolute; inset: 0; background: var(--overlay); z-index: 1; pointer-events: none; }

  #cutout-hero-{{ section.id }} .cutout-hero__content { position: relative; z-index: 2; width: 100%; height: calc(100% - var(--pt) - var(--pb)); display: grid; place-items: center; padding: 2vw; }

  #cutout-hero-{{ section.id }} .cutout-hero__titleWrap { width: 100%; }
  #cutout-hero-{{ section.id }} .cutout-hero__title {
    margin: 0;
    text-align: center;
    font-weight: var(--weight);
    letter-spacing: var(--letter);
    line-height: var(--line);
    font-size: var(--font-size);
    text-transform: uppercase;
    color: var(--text-color);
    font-family: var(--heading-font-family, 'Helvetica Neue', Arial, sans-serif);
    will-change: font-size;
  }

  #cutout-hero-{{ section.id }} .cutout-hero__title--masked {
    color: transparent;
    -webkit-text-stroke: 0px transparent;
    background-image: url('{{ bg_image | image_url: width: 2400 }}');
    background-size: cover;
    background-position: center center;
    -webkit-background-clip: text;
    background-clip: text;
  }

  /* Scribble overlay paths */
  #cutout-hero-{{ section.id }} .cutout-hero__scribble { position: absolute; top: 0; left: 0; width: min(40vw, 600px); pointer-events: none; z-index: 3; }
  #cutout-hero-{{ section.id }} .cutout-hero__scribble svg { width: 100%; height: auto; }
  #cutout-hero-{{ section.id }} .cutout-hero__scribble path { stroke: var(--scribble-stroke); stroke-width: var(--scribble-width); fill: none; stroke-linecap: round; }

  /* Scribble text as font */
  #cutout-hero-{{ section.id }} .cutout-hero__subtitle {
    position: absolute;
    top: 0;
    left: 0;
    transform: translate(var(--scribble-text-offset-x), var(--scribble-text-offset-y)) rotate(var(--scribble-text-rotation));
    transform-origin: top left;
    z-index: 4;
    pointer-events: none;
    mix-blend-mode: multiply;
    color: var(--scribble-text-color);
  }
  #cutout-hero-{{ section.id }} .cutout-hero__subtitle svg { width: clamp(220px, 26vw, 520px); height: auto; }
  #cutout-hero-{{ section.id }} .cutout-hero__subtitle text {
    stroke-dasharray: 1600;
    stroke-dashoffset: 1600;
    paint-order: stroke fill;
    stroke-width: var(--scribble-subtitle-stroke-width);
    font-size: var(--scribble-text-size);
    font-family: var(--scribble-font-stack, 'Brush Script MT', 'Segoe Script', cursive);
  }
  #cutout-hero-{{ section.id }} .cutout-hero__subtitle-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }

  @media (max-width: 768px) {
    #cutout-hero-{{ section.id }} { --font-size: 14vw; --line: 62px; }
    #cutout-hero-{{ section.id }} .cutout-hero__scribble { width: min(60vw, 420px); }
    #cutout-hero-{{ section.id }} .cutout-hero__subtitle svg { width: clamp(180px, 50vw, 400px); }
  }
</style>

<script>
  (function(){
    var root = document.getElementById('cutout-hero-{{ section.id }}');
    if(!root) return;
    function load(src){return new Promise(function(res,rej){var s=document.createElement('script');s.src=src;s.async=true;s.onload=res;s.onerror=rej;document.head.appendChild(s);});}

    function init(){
      var bgImg = root.querySelector('.cutout-hero__bg img');
      var title = root.querySelector('.cutout-hero__title');
      var titleWrap = root.querySelector('.cutout-hero__titleWrap');
      var scribblePaths = root.querySelectorAll('.cutout-hero__scribble path');
      var scribbleText = root.querySelector('.cutout-hero__subtitle text');

      function fitTitle(){
        if(!title || !titleWrap) return;
        // Automatically size font to fit container height (rough approximation)
        var containerH = titleWrap.clientHeight;
        var titleH = title.scrollHeight;
        if (titleH <= 0) return;
        var computedFS = parseFloat(getComputedStyle(title).fontSize);
        var scale = containerH / titleH;
        if (scale < 0.98 || scale > 1.05) {
          title.style.fontSize = (computedFS * Math.min(1.2, Math.max(0.6, scale))) + 'px';
          // re-evaluate once
          titleH = title.scrollHeight;
          scale = containerH / titleH;
          title.style.fontSize = (parseFloat(getComputedStyle(title).fontSize) * Math.min(1.1, Math.max(0.8, scale))) + 'px';
        }
      }

      function setup(){
        if(typeof gsap==='undefined' || typeof ScrollTrigger==='undefined'){ return; }
        gsap.registerPlugin(ScrollTrigger);
        // Parallax background
        if(bgImg){
          gsap.to(bgImg, { yPercent: -1 * ({{ parallax_strength | default: 20 }}), ease: 'none', scrollTrigger: { trigger: root, start: 'top bottom', end: 'bottom top', scrub: true } });
        }
        // Parallax inside cutout text
        if(title){
          gsap.to(title, { backgroundPositionY: function(){return ({{ parallax_strength | default: 20 }}*5)+'px';}, ease: 'none', scrollTrigger: { trigger: root, start: 'top bottom', end: 'bottom top', scrub: true } });
        }
        // SVG path scribble
        if(scribblePaths && scribblePaths.length){
          scribblePaths.forEach(function(p){
            var len = p.getTotalLength ? p.getTotalLength() : 600;
            p.style.strokeDasharray = len;
            p.style.strokeDashoffset = len;
            gsap.to(p, { strokeDashoffset: 0, duration: {{ scribble_duration | default: 1.5 }}, ease: 'power2.out', scrollTrigger: { trigger: root, start: 'top 80%', once: true }});
          });
        }
        // Scribble text draw
        if(scribbleText){
          var lenT = (typeof scribbleText.getComputedTextLength === 'function') ? scribbleText.getComputedTextLength() : 1600;
          scribbleText.style.strokeDasharray = lenT;
          scribbleText.style.strokeDashoffset = lenT;
          var subtitleTimeline = gsap.timeline({
            scrollTrigger: { trigger: root, start: 'top 80%', once: true }
          });
          subtitleTimeline.to(scribbleText, {
            strokeDashoffset: 0,
            duration: {{ scribble_duration | default: 1.5 }},
            ease: 'power2.out'
          });
          {% if scribble_text_fill_after %}
            subtitleTimeline.to(scribbleText, {
              attr: { 'fill-opacity': 1 },
              duration: 0.4,
              ease: 'power1.out'
            }, '-=0.25');
          {% endif %}
        }
        fitTitle();
        window.addEventListener('resize', fitTitle);
      }

      if(typeof gsap==='undefined'){
        load('https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js').then(function(){return load('https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/ScrollTrigger.min.js');}).then(setup).catch(function(){});
      } else {
        if(typeof ScrollTrigger==='undefined'){
          load('https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/ScrollTrigger.min.js').then(setup);
        } else { setup(); }
      }
    }

    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
  })();
</script>

{% schema %}
{
  "name": "Cutout Parallax Hero",
  "settings": [
    {"type":"image_picker","id":"bg_image","label":"Background image (desktop)"},
    {"type":"image_picker","id":"bg_image_mobile","label":"Background image (mobile)"},
    {"type":"color","id":"overlay_color","label":"Overlay color","default":"#FAF7EF"},
    {"type":"range","id":"section_height","label":"Section height (vh)","min":40,"max":120,"step":5,"default":80,"unit":"vh"},
    {"type":"range","id":"padding_top","label":"Padding top","min":0,"max":200,"step":4,"default":40,"unit":"px"},
    {"type":"range","id":"padding_bottom","label":"Padding bottom","min":0,"max":200,"step":4,"default":40,"unit":"px"},
    {"type":"textarea","id":"heading_text","label":"Cutout heading","default":"FOR PROFESSIONAL AND HOME USE · BAKERY · HORECA · CONFECTIONERY"},
    {"type":"color","id":"text_color","label":"Heading color (used when no mask image)","default":"#000000"},
    {"type":"select","id":"heading_font_choice","label":"Heading font","options":[{"value":"sans","label":"Bold Sans"},{"value":"serif","label":"Modern Serif"},{"value":"condensed","label":"Condensed Sans"},{"value":"mono","label":"Mono Display"}],"default":"sans"},
    {"type":"select","id":"text_weight","label":"Font weight","options":[{"value":"700","label":"Bold 700"},{"value":"800","label":"Extra-bold 800"},{"value":"900","label":"Black 900"}],"default":"900"},
    {"type":"range","id":"font_size","label":"Font size (vw)","min":6,"max":16,"step":0.5,"default":10,"unit":"vw"},
    {"type":"range","id":"line_height","label":"Line height (px)","min":50,"max":140,"step":2,"default":92,"unit":"px"},
    {"type":"range","id":"letter_spacing","label":"Letter spacing (px)","min":-2,"max":6,"step":0.5,"default":0,"unit":"px"},
    {"type":"range","id":"parallax_strength","label":"Parallax strength","min":0,"max":40,"step":2,"default":20},

    {"type":"header","content":"Scribble Paths (optional)"},
    {"type":"checkbox","id":"enable_scribble","label":"Show scribble path overlay","default":true},
    {"type":"color","id":"scribble_stroke","label":"Scribble stroke color","default":"#000000"},
    {"type":"range","id":"scribble_width","label":"Scribble stroke width","min":1,"max":10,"step":1,"default":4,"unit":"px"},
    {"type":"range","id":"scribble_duration","label":"Scribble draw duration (s)","min":0.5,"max":6,"step":0.1,"default":1.5,"unit":"s"},
    {"type":"text","id":"scribble_viewbox","label":"Scribble SVG viewBox","default":"0 0 600 180","info":"Format: minX minY width height"},
    {"type":"textarea","id":"scribble_svg_paths","label":"Custom scribble <path> markup","info":"Paste one or more <path ... /> elements. They will inherit stroke settings above.","default":"<path d='M15 120 C60 10, 140 200, 200 40'/>"},

    {"type":"header","content":"Scribble Text (optional)"},
    {"type":"checkbox","id":"enable_scribble_text","label":"Use scribble text (custom font)","default":false},
    {"type":"text","id":"scribble_text","label":"Scribble text","default":"Ways of Using"},
    {"type":"select","id":"scribble_font_choice","label":"Scribble font style","options":[{"value":"script","label":"Handwritten Script"},{"value":"marker","label":"Marker Bold"},{"value":"serif","label":"Serif"},{"value":"sans","label":"Sans"}],"default":"script"},
    {"type":"url","id":"scribble_font_url","label":"Scribble font .woff2 URL"},
    {"type":"text","id":"scribble_font_family","label":"Scribble font family name","default":"ScribbleCustom"},
    {"type":"range","id":"scribble_text_size","label":"Scribble text size (vw)","min":2,"max":18,"step":0.5,"default":8,"unit":"vw"},
    {"type":"color","id":"scribble_text_color","label":"Scribble text color","default":"#000000"},
    {"type":"range","id":"scribble_text_offset_x","label":"Scribble horizontal offset (vw)","min":-20,"max":20,"step":0.5,"default":-6,"unit":"vw"},
    {"type":"range","id":"scribble_text_offset_y","label":"Scribble vertical offset (vw)","min":-20,"max":20,"step":0.5,"default":-8,"unit":"vw"},
    {"type":"range","id":"scribble_text_rotation","label":"Scribble rotation (deg)","min":-30,"max":30,"step":1,"default":-6,"unit":"deg"},
    {"type":"range","id":"scribble_text_stroke_width","label":"Scribble stroke width (px)","min":0.5,"max":10,"step":0.5,"default":2,"unit":"px"},
    {"type":"checkbox","id":"scribble_text_fill_after","label":"Fill scribble text after drawing","default":true}
  ],
  "presets": [
    {"name":"Cutout Parallax Hero"}
  ]
}
{% endschema %}

