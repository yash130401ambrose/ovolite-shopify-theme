{% liquid
  assign section_id = 'bm-scroll-' | append: section.id
  assign heading = section.settings.heading | default: 'What Makes Us Special'
  assign subheading = section.settings.subheading
  assign text_color = section.settings.text_color | default: '#151515'
  assign bg_color = section.settings.background_color | default: '#F6F7F4'
  assign bg_color_end = section.settings.background_color_end | default: bg_color
  assign container_width = section.settings.container | default: 'container'
  assign card_gap = section.settings.card_gap | default: 32
  assign animation_duration = section.settings.animation_duration | default: 1.6
  assign animation_delay = section.settings.animation_delay | default: 0.15
  assign overlay_opacity = section.settings.overlay_opacity | default: 0.65
  assign heading_size = section.settings.heading_size | default: 'h1'
  assign card_radius = section.settings.card_radius | default: 24
  assign card_padding_vertical = section.settings.card_padding_vertical | default: 0
  assign card_padding_horizontal = section.settings.card_padding_horizontal | default: 0
  assign card_min_height = section.settings.card_min_height | default: 0
%}

<section
  id="{{ section_id }}"
  class="bm-scroll"
  style="--bm-text: {{ text_color }}; --bm-card-text: {{ text_color }}; --bm-bg: {{ bg_color }}; --bm-bg-end: {{ bg_color_end }}; --bm-gap: {{ card_gap }}px; --bm-duration: {{ animation_duration }}s; --bm-delay: {{ animation_delay }}s; --bm-radius: {{ card_radius }}px; --bm-overlay: {{ overlay_opacity }};{% if card_padding_vertical > 0 %} --bm-card-pad-top: {{ card_padding_vertical }}px; --bm-card-pad-bottom: {{ card_padding_vertical }}px;{% endif %}{% if card_padding_horizontal > 0 %} --bm-card-pad-inline: {{ card_padding_horizontal }}px;{% endif %}{% if card_min_height > 0 %} --bm-card-height: {{ card_min_height }}px;{% endif %}"
>
  <div class="scroll-squiggle-bg">
    <svg class="scroll-squiggle-svg" viewBox="0 0 800 800" fill="none">
      <path id="scroll-squiggle-path"
        d="M245.813 59.5015C54.1619 152.668 -34.1186 356.234 41.6525 512.101C117.424 667.969 332.042 724.289 523.692 631.123C715.343 537.957 803.624 334.39 727.852 178.522C652.081 22.6546 437.463 -33.6648 245.813 59.5015Z"
        stroke="#FFFFFF"
        stroke-width="28"
        stroke-linecap="round"
        fill="none"
      />
    </svg>
  </div>
  <div class="{{ container_width }} bm-scroll__inner">
    {% if subheading != blank %}
      <p class="bm-scroll__eyebrow">{{ subheading }}</p>
    {% endif %}
    <div class="bm-scroll__heading-wrap">
      {% if section.settings.heading_bg_image_desktop or section.settings.heading_bg_image_mobile %}
        <div class="bm-heading-bg" aria-hidden="true">
          <picture>
            {% if section.settings.heading_bg_image_mobile %}
              <source media="(max-width: 768px)" srcset="{{ section.settings.heading_bg_image_mobile | image_url: width: 1400 }}">
            {% endif %}
            {% if section.settings.heading_bg_image_desktop %}
              <img src="{{ section.settings.heading_bg_image_desktop | image_url: width: 2400 }}" alt="" loading="lazy" />
            {% else %}
              <img src="{{ section.settings.heading_bg_image_mobile | image_url: width: 1800 }}" alt="" loading="lazy" />
            {% endif %}
          </picture>
        </div>
      {% endif %}
      <h2 class="bm-scroll__heading {{ heading_size }}">
        {{ heading }}
      </h2>
    </div>
    <div class="bm-scroll__viewport">
      <div class="bm-scroll__cards">
        {% for block in section.blocks %}
          {% case block.type %}
            {% when 'card' %}
              {% liquid
                assign label = block.settings.label
                assign title = block.settings.title
                assign body = block.settings.body
                assign icon = block.settings.icon
                assign icon_size = block.settings.icon_size | default: 84
                assign accent = block.settings.accent_color | default: '#D4E7C7'
                assign link = block.settings.link
                assign link_label = block.settings.link_label
              %}
              <article class="bm-card" style="{% if accent %}--bm-card-accent: {{ accent }};{% endif %} --bm-badge-size: {{ icon_size }}px;" {{ block.shopify_attributes }}>
                <div class="bm-card__inner">
                  {% if icon != blank %}
                    <div class="bm-card__icon">
                      <img src="{{ icon | image_url: width: 120 }}" alt="" loading="lazy" />
                    </div>
                  {% endif %}
                  {% if label != blank %}
                    <span class="bm-card__label">{{ label }}</span>
                  {% endif %}
                  {% if title != blank %}
                    <h3 class="bm-card__title">{{ title }}</h3>
                  {% endif %}
                  {% if body != blank %}
                    <p class="bm-card__body">{{ body }}</p>
                  {% endif %}
                  {% if link != blank and link_label != blank %}
                    <a href="{{ link }}" class="bm-card__link">{{ link_label }}</a>
                  {% endif %}
                </div>
              </article>
          {% endcase %}
        {% endfor %}
      </div>
    </div>
  </div>
</section>

<style>
  #{{ section_id }} {
    position: relative;
    overflow: hidden;
    padding: clamp(32px, 8vw, 120px) 0;
    background: var(--bm-bg);
    color: var(--bm-text);
    transition: background-color 0.6s ease;
    z-index: 1;
  }
  #{{ section_id }}::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(120deg, var(--bm-bg) 0%, color-mix(in srgb, var(--bm-bg-end) 70%, transparent) 100%);
    opacity: var(--bm-overlay);
    pointer-events: none;
    transition: opacity 0.6s ease;
  }

  #{{ section_id }} .scroll-squiggle-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    overflow: visible;
    pointer-events: none;
    z-index: 0;
  }

  #{{ section_id }} .scroll-squiggle-svg {
    width: 100%;
    height: auto;
    opacity: 1;
  }
  #{{ section_id }}.is-last-centered {
    background: var(--bm-bg-end);
  }
  #{{ section_id }} .bm-scroll__inner {
    position: relative;
    z-index: 2;
    display: grid;
    gap: clamp(32px, 4vw, 64px);
    min-height: clamp(520px, 80vh, 1100px);
  }
  #{{ section_id }} .bm-scroll__eyebrow {
    text-transform: uppercase;
    letter-spacing: 0.28em;
    font-weight: 600;
    font-size: clamp(12px, 1.2vw, 14px);
    text-align: center;
    margin: 0 auto;
    opacity: 0.7;
    color: var(--bm-text);
  }
  #{{ section_id }} .bm-scroll__heading-wrap {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    display: grid;
    place-items: center;
    z-index: 1;
  }
  #{{ section_id }} .bm-scroll__heading {
    margin: 0;
    text-align: center;
    font-size: clamp(36px, 6vw, 80px);
    line-height: 1;
    max-width: clamp(420px, 60vw, 820px);
    text-transform: uppercase;
    letter-spacing: 0.04em;
    pointer-events: none;
    color: var(--bm-text);
  }
  #{{ section_id }} .bm-heading-bg {
    position: absolute;
    inset: 50% auto auto 50%;
    transform: translate(-50%, -50%);
    width: min(92vw, 1200px);
    z-index: -1;
    opacity: 0.9;
    pointer-events: none;
  }
  #{{ section_id }} .bm-heading-bg picture, 
  #{{ section_id }} .bm-heading-bg img {
    display: block;
    width: 100%;
    height: auto;
    object-fit: cover;
    pointer-events: none;
  }
  #{{ section_id }} .bm-scroll__viewport {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    overflow: visible;
    width: 100%;
    min-height: clamp(360px, 42vw, 620px);
    display: grid;
    place-items: center;
    z-index: 2; /* above heading to hide it */
  }
  #{{ section_id }} .bm-scroll__cards {
    display: flex;
    align-items: center;
    gap: calc(var(--bm-gap) * 2.2);
    will-change: transform;
    transform: translate3d(120vw, 0, 0);
    opacity: 1;
    z-index: 2;
  }
  #{{ section_id }} .bm-card {
    flex: 0 0 clamp(320px, 32vw, 500px);
    position: relative;
    background: var(--bm-card-accent, #d4e7c7);
    border-radius: var(--bm-radius);
    min-height: var(--bm-card-height, auto);
    padding-top: var(--bm-card-pad-top, clamp(56px, 5.4vw, 96px));
    padding-bottom: var(--bm-card-pad-bottom, clamp(48px, 3.6vw, 72px));
    padding-left: var(--bm-card-pad-inline, clamp(40px, 4.2vw, 72px));
    padding-right: var(--bm-card-pad-inline, clamp(40px, 4.2vw, 72px));
    color: var(--bm-card-text, var(--bm-text));
    backdrop-filter: blur(6px);
    transition: none;
  }
  #{{ section_id }} .bm-card__inner {
    display: grid;
    gap: clamp(20px, 2vw, 28px);
    justify-items: center;
    text-align: center;
  }
  #{{ section_id }} .bm-card__icon {
    position: absolute;
    left: 50%;
    top: 0;
    transform: translate(-50%, -55%);
    width: var(--bm-badge-size, 84px);
    height: var(--bm-badge-size, 84px);
    border-radius: 50%;
    display: grid;
    place-items: center;
    background: rgba(255,255,255,0.9);
    box-shadow:
      0 8px 24px rgba(0,0,0,0.12),
      inset 0 0 0 2px rgba(0,0,0,0.05);
    overflow: hidden;
  }
  #{{ section_id }} .bm-card__icon img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  #{{ section_id }} .bm-card__label {
    font-size: clamp(14px, 1.4vw, 16px);
    text-transform: uppercase;
    letter-spacing: 0.18em;
    font-weight: 600;
    opacity: 0.85;
    color: var(--bm-card-text, var(--bm-text));
  }
  #{{ section_id }} .bm-card__title {
    margin: 0;
    font-size: clamp(28px, 3.4vw, 44px);
    line-height: 1.1;
    text-transform: uppercase;
    color: #fff;
  }
  #{{ section_id }} .bm-card__body {
    margin: 0;
    font-size: clamp(18px, 1.8vw, 22px);
    line-height: 1.5;
    color: #fff;
  }
  #{{ section_id }} .bm-card__link {
    font-size: clamp(14px, 1.3vw, 16px);
    text-transform: uppercase;
    letter-spacing: 0.2em;
    font-weight: 600;
    color: var(--bm-card-text, var(--bm-text));
    text-decoration: none;
    position: relative;
  }
  #{{ section_id }} .bm-card__link::after {
    display: none;
  }

  @media (max-width: 1024px) {
    #{{ section_id }} .bm-scroll__cards {
      transform: translate3d(60vw, 0, 0);
    }
    #{{ section_id }} .bm-card {
      flex-basis: clamp(220px, 54vw, 300px);
    }
  }

  @media (max-width: 768px) {
    #{{ section_id }} {
      padding: clamp(40px, 18vw, 120px) 0;
    }
    #{{ section_id }} .bm-scroll__heading {
      font-size: clamp(30px, 12vw, 48px);
      max-width: 90%;
    }
    #{{ section_id }} .bm-scroll__cards {
      gap: clamp(16px, 6vw, 32px);
      transform: translate3d(100%, 0, 0);
    }
    #{{ section_id }} .bm-card {
      flex-basis: clamp(220px, 80vw, 280px);
    }
    #{{ section_id }} .bm-card:hover {
      transform: none;
    }
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  var sectionEl = document.getElementById('{{ section_id }}');
  if (!sectionEl) return;

  var path = sectionEl.querySelector("#scroll-squiggle-path");
  if (!path) return;

  var length = path.getTotalLength();
  path.style.strokeDasharray = length;
  path.style.strokeDashoffset = length;

  function loadGSAP(callback) {
    if (window.gsap && window.ScrollTrigger) {
      callback();
      return;
    }
    var gsapScript = document.createElement("script");
    gsapScript.src = "https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js";
    gsapScript.onload = function() {
      var stScript = document.createElement("script");
      stScript.src = "https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js";
      stScript.onload = callback;
      document.body.appendChild(stScript);
    };
    document.body.appendChild(gsapScript);
  }

  loadGSAP(function() {
    if (typeof gsap === 'undefined' || typeof ScrollTrigger === 'undefined') return;
    gsap.registerPlugin(ScrollTrigger);

    gsap.to(path, {
      strokeDashoffset: 0,
      ease: "none",
      scrollTrigger: {
        trigger: sectionEl.querySelector('.scroll-squiggle-bg') || sectionEl,
        start: "top 80%",
        end: "bottom 20%",
        scrub: 1
      }
    });
  });
});
</script>

<script>
  (function() {
    var section = document.getElementById('{{ section_id }}');
    if (!section) return;

    function loadScript(src) {
      return new Promise(function(resolve, reject) {
        var s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }

    function initAnimation() {
      var track = section.querySelector('.bm-scroll__cards');
      var viewport = section.querySelector('.bm-scroll__viewport');
      if (!track || !viewport) return;

      var cards = track.querySelectorAll('.bm-card');
      if (!cards.length) return;

      var totalWidth = 0;
      cards.forEach(function(card) { totalWidth += card.offsetWidth; });
      var styles = getComputedStyle(track);
      var gap = parseFloat(styles.columnGap || styles.gap || 0) || 0;
      totalWidth += gap * (cards.length - 1);

      var viewportWidth = viewport.offsetWidth;

      // Compute target so a group of 3 cards ends centered over the heading
      var mid = Math.max(0, Math.min(cards.length - 1, Math.floor(cards.length / 2)));
      var startIdx = Math.max(0, mid - 1);
      var endIdx = Math.min(cards.length - 1, startIdx + 2);
      // Measure group bounds relative to track
      var trackRect = track.getBoundingClientRect();
      var firstRect = cards[startIdx].getBoundingClientRect();
      var groupLastRect = cards[endIdx].getBoundingClientRect();
      var groupLeft = firstRect.left - trackRect.left;
      var groupRight = groupLastRect.right - trackRect.left;
      var groupCenter = (groupLeft + groupRight) / 2;
      var targetMidOffset = (viewportWidth / 2) - groupCenter;

      if (typeof gsap === 'undefined' || typeof ScrollTrigger === 'undefined') {
        return;
      }

      gsap.registerPlugin(ScrollTrigger);

      // Pin the section while cards slide across the heading
      var initialX = viewportWidth * 1.15;
      var lastCard = cards[cards.length - 1];
      var finalRect = lastCard.getBoundingClientRect();
      var finalCenter = (finalRect.left + finalRect.right) / 2 - trackRect.left;
      var finalOffset = (viewportWidth / 2) - finalCenter;

      var firstDuration = 0.6;
      var needsFinalPhase = Math.abs(finalOffset - targetMidOffset) > 1;
      var secondDuration = needsFinalPhase ? 0.4 : 0;
      var totalDuration = firstDuration + secondDuration;
      var lastPhaseStart = needsFinalPhase ? firstDuration / totalDuration : 1;
      var tolerance = 0.02;

      var tl = gsap.timeline({
        scrollTrigger: {
          trigger: section,
          start: 'top top',
          end: '+=' + Math.max(900, viewportWidth * 2.0),
          pin: true,
          scrub: true,
          anticipatePin: 1,
          onUpdate: function(self) {
            if (self.progress >= lastPhaseStart - tolerance) {
              section.classList.add('is-last-centered');
            } else {
              section.classList.remove('is-last-centered');
            }
          }
        }
      });

      tl.fromTo(track, { x: initialX }, { x: targetMidOffset, duration: firstDuration, ease: 'none' });

      if (needsFinalPhase) {
        tl.to(track, { x: finalOffset, duration: secondDuration, ease: 'none' });
      }
    }

    function ready(fn) {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fn);
      } else {
        fn();
      }
    }

    ready(function() {
      if (typeof gsap === 'undefined') {
        loadScript('https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js')
          .then(function() {
            if (typeof ScrollTrigger === 'undefined') {
              return loadScript('https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/ScrollTrigger.min.js');
            }
          })
          .then(initAnimation)
          .catch(initAnimation);
      } else {
        if (typeof ScrollTrigger === 'undefined') {
          loadScript('https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/ScrollTrigger.min.js')
            .then(initAnimation)
            .catch(initAnimation);
        } else {
          initAnimation();
        }
      }
    });

    document.addEventListener('shopify:section:load', function(e) {
      if (!section.contains(e.target)) return;
      initAnimation();
    });
  })();
</script>

{% schema %}
{
  "name": "Scroll Cards BM",
  "settings": [
    {
      "type": "select",
      "id": "container",
      "label": "Width",
      "default": "container",
      "options": [
        { "value": "container", "label": "Default" },
        { "value": "container-fluid", "label": "Full width" },
        { "value": "container-full", "label": "Edge to edge" }
      ]
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "What Makes Us Special"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Eyebrow text"
    },
    {
      "type": "select",
      "id": "heading_size",
      "label": "Heading size",
      "default": "h1",
      "options": [
        { "value": "h1", "label": "Display" },
        { "value": "h2", "label": "Large" },
        { "value": "h3", "label": "Medium" }
      ]
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#151515"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background start color",
      "default": "#F6F7F4"
    },
    {
      "type": "color",
      "id": "background_color_end",
      "label": "Background end color",
      "default": "#DCE7D5"
    },
    {
      "type": "image_picker",
      "id": "heading_bg_image_desktop",
      "label": "Heading background image (desktop)"
    },
    {
      "type": "image_picker",
      "id": "heading_bg_image_mobile",
      "label": "Heading background image (mobile)"
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "label": "Background overlay strength",
      "min": 0,
      "max": 1,
      "step": 0.1,
      "default": 0.6
    },
    {
      "type": "range",
      "id": "card_gap",
      "label": "Card spacing",
      "min": 12,
      "max": 64,
      "step": 4,
      "default": 32,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "card_radius",
      "label": "Card corner radius",
      "min": 0,
      "max": 48,
      "step": 4,
      "default": 24,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "card_padding_vertical",
      "label": "Card padding (top & bottom)",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 0,
      "unit": "px",
      "info": "Set to 0 to use the default responsive padding"
    },
    {
      "type": "range",
      "id": "card_padding_horizontal",
      "label": "Card padding (sides)",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 0,
      "unit": "px",
      "info": "Set to 0 to use the default responsive padding"
    },
    {
      "type": "range",
      "id": "card_min_height",
      "label": "Card minimum height",
      "min": 0,
      "max": 900,
      "step": 20,
      "default": 0,
      "unit": "px",
      "info": "Leave at 0 to let cards size naturally"
    },
    {
      "type": "range",
      "id": "animation_duration",
      "label": "Scroll animation duration",
      "min": 0.5,
      "max": 4,
      "step": 0.1,
      "default": 1.6,
      "unit": "s"
    },
    {
      "type": "range",
      "id": "animation_delay",
      "label": "Card stagger delay",
      "min": 0,
      "max": 1,
      "step": 0.1,
      "default": 0.1,
      "unit": "s"
    }
  ],
  "blocks": [
    {
      "type": "card",
      "name": "Card",
      "settings": [
        {
          "type": "text",
          "id": "label",
          "label": "Card label",
          "default": "More caffeine"
        },
        {
          "type": "range",
          "id": "icon_size",
          "label": "Badge icon size",
          "min": 40,
          "max": 140,
          "step": 2,
          "default": 84,
          "unit": "px"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Card title",
          "default": "Special Blend"
        },
        {
          "type": "textarea",
          "id": "body",
          "label": "Description",
          "default": "85mg of caffeine per serving, equal to a cappuccino. Your daily energy boost."
        },
        {
          "type": "image_picker",
          "id": "icon",
          "label": "Icon image"
        },
        {
          "type": "color",
          "id": "accent_color",
          "label": "Accent color",
          "default": "#D4E7C7"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link"
        },
        {
          "type": "text",
          "id": "link_label",
          "label": "Link label",
          "default": "Shop now"
        }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [
    {
      "name": "Scroll Cards BM",
      "blocks": [
        { "type": "card" },
        { "type": "card" },
        { "type": "card" }
      ]
    }
  ]
}
{% endschema %}

