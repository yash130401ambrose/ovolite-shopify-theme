{% liquid
  assign top_color = section.settings.top_color | default: '#F5F0E8'
  assign bottom_color = section.settings.bottom_color | default: '#FAF7F2'
  assign drip_height = section.settings.drip_height | default: 100
  assign wave_style = section.settings.wave_style | default: 'medium'
  assign mask_image_above = section.settings.mask_image_above | default: false
%}

{% capture mask_path %}
  {% case wave_style %}
    {% when 'subtle' %}
      M0,0 L0,50 Q360,60 720,50 T1440,50 L1440,0 Z
    {% when 'dramatic' %}
      M0,0 L0,40 Q180,90 360,40 T720,50 T1080,40 T1440,75 L1440,0 Z
    {% when 'organic' %}
      M0,0 L0,55 Q120,75 240,50 T480,48 T720,45 T960,50 T1200,52 L1440,52 L1440,0 Z
    {% else %}
      M0,0 L0,60 Q360,80 720,50 T1440,50 L1440,0 Z
  {% endcase %}
{% endcapture %}

{% assign mask_path = mask_path | strip | replace: '\n', ' ' %}

{% capture mask_svg %}
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 120" preserveAspectRatio="none"><path d="{{ mask_path }}" fill="white"/></svg>
{% endcapture %}

{% if mask_image_above %}
  {% comment %} Mask mode: The divider acts as a mask for the section above {% endcomment %}
  <div class="liquid-drip-mask-wrapper" style="--drip-height: {{ drip_height }}px; --top-color: {{ top_color }}; --bottom-color: {{ bottom_color }};">
    <div class="liquid-drip-mask liquid-drip-{{ wave_style }}" style="--drip-height: var(--drip-height);">
      <svg class="liquid-drip-mask-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 120" preserveAspectRatio="none">
        <path d="{{ mask_path }}" fill="white"/>
      </svg>
    </div>
  </div>
{% else %}
  {% comment %} Normal mode: Standard divider between sections {% endcomment %}
  <div class="liquid-drip-divider-section" style="--drip-height: {{ drip_height }}px; --top-color: {{ top_color }}; --bottom-color: {{ bottom_color }};">
    <svg class="liquid-drip-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 120" preserveAspectRatio="none">
      {% case wave_style %}
        {% when 'subtle' %}
          <path d="M0,0 L0,50 L1440,50 L1440,120 L0,120 Z" fill="var(--bottom-color)"/>
          <path d="M0,50 Q360,60 720,50 T1440,50 L1440,0 L0,0 Z" fill="var(--top-color)"/>
        {% when 'dramatic' %}
          <path d="M0,0 L0,40 L1440,75 L1440,120 L0,120 Z" fill="var(--bottom-color)"/>
          <path d="M0,40 Q180,90 360,40 T720,50 T1080,40 T1440,75 L1440,0 L0,0 Z" fill="var(--top-color)"/>
        {% when 'organic' %}
          <path d="M0,0 L0,55 L1440,52 L1440,120 L0,120 Z" fill="var(--bottom-color)"/>
          <path d="M0,55 Q120,75 240,50 T480,48 T720,45 T960,50 T1200,52 L1440,52 L1440,0 L0,0 Z" fill="var(--top-color)"/>
        {% else %}
          <path d="M0,0 L0,60 L1440,50 L1440,120 L0,120 Z" fill="var(--bottom-color)"/>
          <path d="M0,60 Q360,80 720,50 T1440,50 L1440,0 L0,0 Z" fill="var(--top-color)"/>
      {% endcase %}
    </svg>
  </div>
{% endif %}

{% if mask_image_above %}
  <script>
    (function() {
      var sectionId = '{{ section.id }}';
      var dripHeight = {{ drip_height | default: 100 }};
      var waveStyle = '{{ wave_style }}';
      var baseWidth = 1440;
      var baseHeight = 120;

      var wavePaths = {
        subtle: [
          { cmd: 'M', args: [0, 0] },
          { cmd: 'L', args: [0, 50] },
          { cmd: 'Q', args: [360, 60, 720, 50] },
          { cmd: 'T', args: [1440, 50] },
          { cmd: 'L', args: [1440, 0] },
          { cmd: 'Z', args: [] }
        ],
        dramatic: [
          { cmd: 'M', args: [0, 0] },
          { cmd: 'L', args: [0, 40] },
          { cmd: 'Q', args: [180, 90, 360, 40] },
          { cmd: 'T', args: [720, 50] },
          { cmd: 'T', args: [1080, 40] },
          { cmd: 'T', args: [1440, 75] },
          { cmd: 'L', args: [1440, 0] },
          { cmd: 'Z', args: [] }
        ],
        organic: [
          { cmd: 'M', args: [0, 0] },
          { cmd: 'L', args: [0, 55] },
          { cmd: 'Q', args: [120, 75, 240, 50] },
          { cmd: 'T', args: [480, 48] },
          { cmd: 'T', args: [720, 45] },
          { cmd: 'T', args: [960, 50] },
          { cmd: 'T', args: [1200, 52] },
          { cmd: 'L', args: [1440, 52] },
          { cmd: 'L', args: [1440, 0] },
          { cmd: 'Z', args: [] }
        ],
        medium: [
          { cmd: 'M', args: [0, 0] },
          { cmd: 'L', args: [0, 60] },
          { cmd: 'Q', args: [360, 80, 720, 50] },
          { cmd: 'T', args: [1440, 50] },
          { cmd: 'L', args: [1440, 0] },
          { cmd: 'Z', args: [] }
        ]
      };

      var commands = wavePaths[waveStyle] || wavePaths.medium;

      var buildPath = function(width, height, dripHeightValue) {
        var scaleX = width / baseWidth;
        var scaleY = dripHeightValue / baseHeight;
        var offsetY = Math.max(height - dripHeightValue, 0);

        return commands.map(function(segment) {
          if (!segment.args.length) {
            return segment.cmd;
          }

          var transformedArgs = segment.args.map(function(value, index) {
            var isY = index % 2 === 1;
            if (isY) {
              if (value === 0) {
                return 0;
              }
              return (offsetY + value * scaleY).toFixed(2);
            }
            return (value * scaleX).toFixed(2);
          });

          return segment.cmd + ' ' + transformedArgs.join(' ');
        }).join(' ');
      };

      var applyClipPath = function(target) {
        if (!target) return;
        var width = target.offsetWidth;
        var height = target.offsetHeight;
        if (!width || !height) return;

        var pathData = buildPath(width, height, Math.min(dripHeight, height));
        var pathValue = 'path("' + pathData + '")';
        target.style.clipPath = pathValue;
        target.style.webkitClipPath = pathValue;
        target.style.overflow = 'hidden';
      };

      var applyMaskToPrevious = function () {
        var sectionEl = document.getElementById('shopify-section-' + sectionId);
        if (!sectionEl) return;

        var previousSection = sectionEl.previousElementSibling;
        while (previousSection && previousSection.nodeType !== 1) {
          previousSection = previousSection.previousElementSibling;
        }
        if (!previousSection || !previousSection.classList.contains('liquid-drip-masked-section')) {
          return;
        }

        applyClipPath(previousSection);

        if (window.ResizeObserver && !previousSection.__liquidDripResizeHandler) {
          var resizeObserver = new ResizeObserver(function() {
            applyClipPath(previousSection);
          });
          resizeObserver.observe(previousSection);
          previousSection.__liquidDripResizeHandler = resizeObserver;
        }
      };

      var init = function() {
        applyMaskToPrevious();
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init, { once: true });
      } else {
        init();
      }

      document.addEventListener('shopify:section:load', function(event) {
        if (event.detail && event.detail.sectionId === sectionId) {
          applyMaskToPrevious();
        }
      });

      document.addEventListener('shopify:section:select', function(event) {
        if (event.detail && event.detail.sectionId === sectionId) {
          applyMaskToPrevious();
        }
      });
    })();
  </script>
{% endif %}

<style>
  /* Normal divider mode */
  .liquid-drip-divider-section {
    position: relative;
    width: 100%;
    height: var(--drip-height);
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: var(--bottom-color);
    line-height: 0;
    display: block;
  }
  
  .liquid-drip-svg {
    width: 100%;
    height: 100%;
    display: block;
    position: relative;
  }
  
  /* Mask mode for image sections above */
  .liquid-drip-mask-wrapper {
    position: relative;
    width: 100%;
    height: var(--drip-height);
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: var(--bottom-color);
    line-height: 0;
    display: block;
    z-index: 1;
  }
  
  .liquid-drip-mask {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: var(--drip-height);
    pointer-events: none;
  }
  
  .liquid-drip-mask-svg {
    width: 100%;
    height: 100%;
    display: block;
  }
  
  /* CSS class to add to the section above when using mask mode */
  .liquid-drip-masked-section {
    position: relative;
    margin-bottom: 0 !important;
    overflow: hidden;
  }
</style>

{% schema %}
{
  "name": "Liquid Drip Divider",
  "settings": [
    {
      "type": "header",
      "content": "Mask Mode"
    },
    {
      "type": "checkbox",
      "id": "mask_image_above",
      "label": "Mask image section above",
      "default": false,
      "info": "When enabled, the liquid drip shape will mask/clip the section above (useful for image sections). The section above will need the class 'liquid-drip-masked-section' added to it."
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "top_color",
      "label": "Top section color",
      "default": "#F5F0E8",
      "info": "Color that appears above the divider (or background for masked sections)"
    },
    {
      "type": "color",
      "id": "bottom_color",
      "label": "Bottom section color",
      "default": "#FAF7F2",
      "info": "Color that appears below the divider"
    },
    {
      "type": "header",
      "content": "Size"
    },
    {
      "type": "range",
      "id": "drip_height",
      "label": "Divider height",
      "min": 50,
      "max": 300,
      "step": 10,
      "default": 100,
      "unit": "px",
      "info": "Height of the liquid drip divider"
    },
    {
      "type": "header",
      "content": "Wave Style"
    },
    {
      "type": "select",
      "id": "wave_style",
      "label": "Wave intensity",
      "default": "medium",
      "options": [
        {
          "value": "subtle",
          "label": "Subtle"
        },
        {
          "value": "medium",
          "label": "Medium"
        },
        {
          "value": "dramatic",
          "label": "Dramatic"
        },
        {
          "value": "organic",
      "label": "Organic"
        }
      ],
      "info": "Choose the intensity of the wave pattern"
    }
  ],
  "presets": [
    {
      "name": "Liquid Drip Divider"
    }
  ]
}
{% endschema %}