{% liquid
  assign top_color = section.settings.top_color | default: '#F5F0E8'
  assign bottom_color = section.settings.bottom_color | default: '#FAF7F2'
  assign drip_height = section.settings.drip_height | default: 100
  assign wave_style = section.settings.wave_style | default: 'medium'
  assign mask_image_above = section.settings.mask_image_above | default: false
%}

{% capture mask_path %}
  {% case wave_style %}
    {% when 'subtle' %}
      M0,0 L0,50 Q360,60 720,50 T1440,50 L1440,0 Z
    {% when 'dramatic' %}
      M0,0 L0,40 Q180,90 360,40 T720,50 T1080,40 T1440,75 L1440,0 Z
    {% when 'organic' %}
      M0,0 L0,55 Q120,75 240,50 T480,48 T720,45 T960,50 T1200,52 L1440,52 L1440,0 Z
    {% else %}
      M0,0 L0,60 Q360,80 720,50 T1440,50 L1440,0 Z
  {% endcase %}
{% endcapture %}

{% assign mask_path = mask_path | strip | replace: '\n', ' ' %}

{% capture mask_svg %}
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 120" preserveAspectRatio="none"><path d="{{ mask_path }}" fill="white"/></svg>
{% endcapture %}

{% assign mask_svg_encoded = mask_svg | strip | uri_escape %}

{% if mask_image_above %}
  {% comment %} Mask mode: The divider acts as a mask for the section above {% endcomment %}
  <div class="liquid-drip-mask-wrapper" style="--drip-height: {{ drip_height }}px; --top-color: {{ top_color }}; --bottom-color: {{ bottom_color }};">
    <div class="liquid-drip-mask liquid-drip-{{ wave_style }}" style="--drip-height: var(--drip-height);">
      <svg class="liquid-drip-mask-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 120" preserveAspectRatio="none">
        <path d="{{ mask_path }}" fill="white"/>
      </svg>
    </div>
  </div>
{% else %}
  {% comment %} Normal mode: Standard divider between sections {% endcomment %}
  <div class="liquid-drip-divider-section" style="--drip-height: {{ drip_height }}px; --top-color: {{ top_color }}; --bottom-color: {{ bottom_color }};">
    <svg class="liquid-drip-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 120" preserveAspectRatio="none">
      {% case wave_style %}
        {% when 'subtle' %}
          <path d="M0,0 L0,50 L1440,50 L1440,120 L0,120 Z" fill="var(--bottom-color)"/>
          <path d="M0,50 Q360,60 720,50 T1440,50 L1440,0 L0,0 Z" fill="var(--top-color)"/>
        {% when 'dramatic' %}
          <path d="M0,0 L0,40 L1440,75 L1440,120 L0,120 Z" fill="var(--bottom-color)"/>
          <path d="M0,40 Q180,90 360,40 T720,50 T1080,40 T1440,75 L1440,0 L0,0 Z" fill="var(--top-color)"/>
        {% when 'organic' %}
          <path d="M0,0 L0,55 L1440,52 L1440,120 L0,120 Z" fill="var(--bottom-color)"/>
          <path d="M0,55 Q120,75 240,50 T480,48 T720,45 T960,50 T1200,52 L1440,52 L1440,0 L0,0 Z" fill="var(--top-color)"/>
        {% else %}
          <path d="M0,0 L0,60 L1440,50 L1440,120 L0,120 Z" fill="var(--bottom-color)"/>
          <path d="M0,60 Q360,80 720,50 T1440,50 L1440,0 L0,0 Z" fill="var(--top-color)"/>
      {% endcase %}
    </svg>
  </div>
{% endif %}

{% if mask_image_above %}
  <script>
    (function() {
      var sectionId = '{{ section.id }}';
      var maskImage = "url('data:image/svg+xml,{{ mask_svg_encoded }}')";
      var dripHeight = '{{ drip_height }}px';
      var topColor = '{{ top_color }}';
      var bottomColor = '{{ bottom_color }}';

      var applyMaskVariables = function () {
        var sectionEl = document.getElementById('shopify-section-' + sectionId);
        if (!sectionEl) return;

        var previousSection = sectionEl.previousElementSibling;

        while (previousSection && previousSection.nodeType !== 1) {
          previousSection = previousSection.previousElementSibling;
        }

        if (!previousSection || !previousSection.classList.contains('liquid-drip-masked-section')) {
          return;
        }

        previousSection.style.setProperty('--liquid-drip-height', dripHeight);
        previousSection.style.setProperty('--liquid-drip-top-color', topColor);
        previousSection.style.setProperty('--liquid-drip-bottom-color', bottomColor);
        previousSection.style.setProperty('--liquid-drip-mask-image', maskImage);
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyMaskVariables, { once: true });
      } else {
        applyMaskVariables();
      }

      document.addEventListener('shopify:section:load', function(event) {
        if (event.detail && event.detail.sectionId === sectionId) {
          applyMaskVariables();
        }
      });

      document.addEventListener('shopify:section:select', function(event) {
        if (event.detail && event.detail.sectionId === sectionId) {
          applyMaskVariables();
        }
      });
    })();
  </script>
{% endif %}

<style>
  /* Normal divider mode */
  .liquid-drip-divider-section {
    position: relative;
    width: 100%;
    height: var(--drip-height);
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: var(--bottom-color);
    line-height: 0;
    display: block;
  }
  
  .liquid-drip-svg {
    width: 100%;
    height: 100%;
    display: block;
    position: relative;
  }
  
  /* Mask mode for image sections above */
  .liquid-drip-mask-wrapper {
    position: relative;
    width: 100%;
    height: var(--drip-height);
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: var(--bottom-color);
    line-height: 0;
    display: block;
    z-index: 1;
  }
  
  .liquid-drip-mask {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: var(--drip-height);
    pointer-events: none;
  }
  
  .liquid-drip-mask-svg {
    width: 100%;
    height: 100%;
    display: block;
  }
  
  /* CSS class to add to the section above when using mask mode */
  .liquid-drip-masked-section {
    position: relative;
    margin-bottom: 0 !important;
    overflow: hidden;
    isolation: isolate;
  }
  
  .liquid-drip-masked-section::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: var(--liquid-drip-height, var(--drip-height, 100px));
    background: #000;
    mask-image: var(--liquid-drip-mask-image, url("data:image/svg+xml,{{ mask_svg_encoded }}"));
    -webkit-mask-image: var(--liquid-drip-mask-image, url("data:image/svg+xml,{{ mask_svg_encoded }}"));
    mask-size: 100% 100%;
    -webkit-mask-size: 100% 100%;
    mask-repeat: no-repeat;
    -webkit-mask-repeat: no-repeat;
    mask-position: bottom;
    -webkit-mask-position: bottom;
    mix-blend-mode: destination-out;
    opacity: 1;
    pointer-events: none;
    z-index: 1;
  }
</style>

{% schema %}
{
  "name": "Liquid Drip Divider",
  "settings": [
    {
      "type": "header",
      "content": "Mask Mode"
    },
    {
      "type": "checkbox",
      "id": "mask_image_above",
      "label": "Mask image section above",
      "default": false,
      "info": "When enabled, the liquid drip shape will mask/clip the section above (useful for image sections). The section above will need the class 'liquid-drip-masked-section' added to it."
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "top_color",
      "label": "Top section color",
      "default": "#F5F0E8",
      "info": "Color that appears above the divider (or background for masked sections)"
    },
    {
      "type": "color",
      "id": "bottom_color",
      "label": "Bottom section color",
      "default": "#FAF7F2",
      "info": "Color that appears below the divider"
    },
    {
      "type": "header",
      "content": "Size"
    },
    {
      "type": "range",
      "id": "drip_height",
      "label": "Divider height",
      "min": 50,
      "max": 300,
      "step": 10,
      "default": 100,
      "unit": "px",
      "info": "Height of the liquid drip divider"
    },
    {
      "type": "header",
      "content": "Wave Style"
    },
    {
      "type": "select",
      "id": "wave_style",
      "label": "Wave intensity",
      "default": "medium",
      "options": [
        {
          "value": "subtle",
          "label": "Subtle"
        },
        {
          "value": "medium",
          "label": "Medium"
        },
        {
          "value": "dramatic",
          "label": "Dramatic"
        },
        {
          "value": "organic",
      "label": "Organic"
        }
      ],
      "info": "Choose the intensity of the wave pattern"
    }
  ],
  "presets": [
    {
      "name": "Liquid Drip Divider"
    }
  ]
}
{% endschema %}