{% liquid
  assign background = section.settings.background | default: '#f5f7ec'
  assign heading_color = section.settings.heading_color | default: '#1f2b1e'
  assign body_color = section.settings.body_color | default: 'rgba(31, 43, 30, 0.72)'
  assign accent_color = section.settings.accent_color | default: '#9ec27d'
  assign padding_top = section.settings.padding_top | default: 96
  assign padding_bottom = section.settings.padding_bottom | default: 96
  assign arch_height = section.settings.arch_height | default: 140
  assign arch_curvature = section.settings.arch_curvature | default: 1.1
%}

<section
  id="ingredient-arch-{{ section.id }}"
  class="ingredient-arch"
  data-arch-height="{{ arch_height }}"
  data-arch-curvature="{{ arch_curvature }}"
  style="--ingredient-bg: {{ background }};
         --ingredient-heading: {{ heading_color }};
         --ingredient-body: {{ body_color }};
         --ingredient-accent: {{ accent_color }};
         --ingredient-padding-top: {{ padding_top }}px;
         --ingredient-padding-bottom: {{ padding_bottom }}px;"
>
  <div class="ingredient-arch__inner">
    {% if section.settings.preheading != blank %}
      <p class="ingredient-arch__eyebrow">{{ section.settings.preheading }}</p>
    {% endif %}

    {% if section.settings.heading != blank %}
      <h2 class="ingredient-arch__heading">{{ section.settings.heading }}</h2>
    {% endif %}

    {% if section.settings.subheading != blank %}
      <div class="ingredient-arch__subheading rte">{{ section.settings.subheading }}</div>
    {% endif %}

    <div class="ingredient-arch__track" data-arch-track>
      {% for block in section.blocks %}
        {% if block.type == 'ingredient' %}
          <div
            class="ingredient-arch__item"
            data-arch-item
            style="--arch-index: {{ forloop.index0 }}; --arch-count: {{ section.blocks.size }};"
            {{ block.shopify_attributes }}
          >
            <div class="ingredient-arch__circle" style="--circle-size: {{ block.settings.circle_size | default: 120 }}px;">
              {% if block.settings.image != blank %}
                {{ block.settings.image | image_url: width: 300 | image_tag: class: 'ingredient-arch__image', alt: block.settings.title | escape }}
              {% else %}
                <span class="ingredient-arch__initial">{{ block.settings.title | slice: 0, 1 }}</span>
              {% endif %}
            </div>
            {% if block.settings.title != blank %}
              <p class="ingredient-arch__title">{{ block.settings.title }}</p>
            {% endif %}
            {% if block.settings.caption != blank %}
              <p class="ingredient-arch__caption">{{ block.settings.caption }}</p>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  <script>
    (function () {
      var section = document.getElementById('ingredient-arch-{{ section.id }}');
      if (!section) { return; }

      var track = section.querySelector('[data-arch-track]');
      if (!track) { return; }

      var archLayout = function () {
        var items = track.querySelectorAll('[data-arch-item]');
        if (!items.length) { return; }

        var archHeight = parseFloat(section.getAttribute('data-arch-height')) || 140;
        var curvature = parseFloat(section.getAttribute('data-arch-curvature')) || 1.1;
        var count = items.length;

        var isMobile = window.matchMedia('(max-width: 768px)').matches;
        Array.prototype.forEach.call(items, function (item, index) {
          if (isMobile) {
            item.style.setProperty('--arch-translate', '0px');
            return;
          }

          var ratio = count === 1 ? 0.5 : index / (count - 1);
          var centered = (ratio - 0.5) * 2;
          var elevation = (1 - Math.pow(Math.abs(centered), curvature)) * archHeight;
          item.style.setProperty('--arch-translate', (-elevation).toFixed(2) + 'px');
        });
      };

      var debouncedResize;
      var handleResize = function () {
        clearTimeout(debouncedResize);
        debouncedResize = setTimeout(archLayout, 120);
      };

      archLayout();
      window.addEventListener('resize', handleResize);

      document.addEventListener('shopify:section:load', function (event) {
        if (event.detail && event.detail.sectionId === '{{ section.id }}') {
          section = document.getElementById('ingredient-arch-{{ section.id }}');
          track = section ? section.querySelector('[data-arch-track]') : null;
          archLayout();
        }
      });

      document.addEventListener('shopify:block:select', function (event) {
        if (event.target && section.contains(event.target)) {
          archLayout();
        }
      });

      document.addEventListener('shopify:block:deselect', function (event) {
        if (event.target && section.contains(event.target)) {
          archLayout();
        }
      });
    })();
  </script>
</section>

<style>
  #ingredient-arch-{{ section.id }} {
    background: var(--ingredient-bg);
    padding: var(--ingredient-padding-top) clamp(20px, 6vw, 80px) var(--ingredient-padding-bottom);
  }

  #ingredient-arch-{{ section.id }} .ingredient-arch__inner {
    width: min(1180px, 100%);
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: clamp(18px, 4vw, 32px);
    text-align: center;
  }

  #ingredient-arch-{{ section.id }} .ingredient-arch__eyebrow {
    font-size: clamp(14px, 2vw, 16px);
    font-weight: 600;
    letter-spacing: 0.22em;
    text-transform: uppercase;
    color: var(--ingredient-accent);
    margin: 0;
  }

  #ingredient-arch-{{ section.id }} .ingredient-arch__heading {
    margin: 0;
    font-size: clamp(36px, 6vw, 56px);
    font-weight: 700;
    color: var(--ingredient-heading);
    letter-spacing: -0.015em;
  }

  #ingredient-arch-{{ section.id }} .ingredient-arch__subheading {
    max-width: min(680px, 100%);
    font-size: clamp(16px, 2.4vw, 18px);
    color: var(--ingredient-body);
    margin: 0;
    line-height: 1.6;
  }

  #ingredient-arch-{{ section.id }} .ingredient-arch__track {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    gap: clamp(18px, 3vw, 32px);
    flex-wrap: nowrap;
  }

  #ingredient-arch-{{ section.id }} .ingredient-arch__item {
    flex: 1 1 12%;
    min-width: 120px;
    max-width: 160px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: clamp(10px, 2vw, 14px);
    transform: translateY(var(--arch-translate, 0px));
    transition: transform 0.45s ease;
  }

  #ingredient-arch-{{ section.id }} .ingredient-arch__circle {
    width: var(--circle-size, 120px);
    height: var(--circle-size, 120px);
    border-radius: 50%;
    background: #ffffff;
    box-shadow: 0 18px 32px rgba(15, 38, 24, 0.18);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  #ingredient-arch-{{ section.id }} .ingredient-arch__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  #ingredient-arch-{{ section.id }} .ingredient-arch__initial {
    font-size: clamp(36px, 6vw, 44px);
    font-weight: 700;
    color: var(--ingredient-heading);
  }

  #ingredient-arch-{{ section.id }} .ingredient-arch__title {
    margin: 0;
    font-size: clamp(16px, 2.4vw, 18px);
    font-weight: 600;
    color: var(--ingredient-heading);
  }

  #ingredient-arch-{{ section.id }} .ingredient-arch__caption {
    margin: 0;
    font-size: clamp(14px, 2vw, 16px);
    color: var(--ingredient-body);
    line-height: 1.4;
  }

  #ingredient-arch-{{ section.id }} .ingredient-arch__item:hover .ingredient-arch__circle {
    transform: translateY(-6px);
    transition: transform 0.35s ease;
  }

  #ingredient-arch-{{ section.id }} .ingredient-arch__item:hover .ingredient-arch__circle::after {
    opacity: 1;
  }

  @media (max-width: 1024px) {
    #ingredient-arch-{{ section.id }} .ingredient-arch__item {
      min-width: 110px;
    }
  }

  @media (max-width: 768px) {
    #ingredient-arch-{{ section.id }} {
      padding: clamp(56px, 12vw, 80px) clamp(16px, 6vw, 36px);
    }

    #ingredient-arch-{{ section.id }} .ingredient-arch__track {
      flex-wrap: wrap;
      justify-content: center;
    }

    #ingredient-arch-{{ section.id }} .ingredient-arch__item {
      flex: 0 1 calc(50% - clamp(12px, 4vw, 24px));
      transform: none !important;
    }
  }

  @media (max-width: 540px) {
    #ingredient-arch-{{ section.id }} .ingredient-arch__item {
      flex: 0 1 calc(50% - 18px);
      min-width: 140px;
    }

    #ingredient-arch-{{ section.id }} .ingredient-arch__circle {
      width: clamp(110px, 36vw, 140px);
      height: clamp(110px, 36vw, 140px);
    }
  }
</style>

{% schema %}
{
  "name": "Ingredient arch",
  "settings": [
    {
      "type": "color",
      "id": "background",
      "label": "Background color",
      "default": "#f5f7ec"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading color",
      "default": "#1f2b1e"
    },
    {
      "type": "color",
      "id": "body_color",
      "label": "Body text color",
      "default": "rgba(31, 43, 30, 0.72)"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Accent color",
      "default": "#9ec27d"
    },
    {
      "type": "text",
      "id": "preheading",
      "label": "Eyebrow text",
      "default": "Premium blend"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Powerhouse ingredients"
    },
    {
      "type": "richtext",
      "id": "subheading",
      "label": "Supporting copy",
      "default": "<p>Everything inside is thoughtfully selected. Hover to learn more about each ingredient in our hero blend.</p>"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "default": 96
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "default": 96
    },
    {
      "type": "range",
      "id": "arch_height",
      "label": "Arch height",
      "min": 40,
      "max": 240,
      "step": 5,
      "unit": "px",
      "default": 140
    },
    {
      "type": "range",
      "id": "arch_curvature",
      "label": "Arch curvature",
      "min": 0.4,
      "max": 2,
      "step": 0.1,
      "default": 1.1
    }
  ],
  "blocks": [
    {
      "type": "ingredient",
      "name": "Ingredient circle",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Ingredient image"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Matcha"
        },
        {
          "type": "textarea",
          "id": "caption",
          "label": "Caption",
          "default": "Loaded with antioxidants to fuel your day."
        },
        {
          "type": "range",
          "id": "circle_size",
          "label": "Circle size",
          "min": 80,
          "max": 200,
          "step": 4,
          "unit": "px",
          "default": 136
        }
      ]
    }
  ],
  "max_blocks": 12,
  "presets": [
    {
      "name": "Ingredient arch",
      "category": "Product",
      "blocks": [
        { "type": "ingredient", "settings": { "title": "Matcha" } },
        { "type": "ingredient", "settings": { "title": "Spirulina" } },
        { "type": "ingredient", "settings": { "title": "Moringa" } },
        { "type": "ingredient", "settings": { "title": "Ashwagandha" } },
        { "type": "ingredient", "settings": { "title": "Chlorella" } },
        { "type": "ingredient", "settings": { "title": "Lion's Mane" } }
      ]
    }
  ]
}
{% endschema %}


