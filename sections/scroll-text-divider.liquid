{% liquid
  assign top_color = section.settings.top_color | default: '#E8F5E9'
  assign bottom_color = section.settings.bottom_color | default: '#F1F8E9'
  assign divider_color = section.settings.divider_color | default: '#2E7D32'
  assign text_color = section.settings.text_color | default: '#A5D6A7'
  assign divider_height = section.settings.divider_height | default: 120
  assign text_size = section.settings.text_size | default: 24
  assign scroll_speed = section.settings.scroll_speed | default: 1
  assign text_content = section.settings.text_content | default: "A) - IT'S A MATCH(A) - IT"
  assign wave_style = section.settings.wave_style | default: 'medium'
  assign animation_direction = section.settings.animation_direction | default: 'right'
  assign repeat_count = section.settings.repeat_count | default: 4
  assign text_spacing = section.settings.text_spacing | default: 50
  assign enable_animation = section.settings.enable_animation | default: true
%}

<div class="scroll-text-divider-wrapper" 
     id="scroll-text-divider-{{ section.id }}"
     data-scroll-speed="{{ scroll_speed }}"
     data-animation-direction="{{ animation_direction }}"
     data-enable-animation="{{ enable_animation }}"
     style="--top-color: {{ top_color }}; --bottom-color: {{ bottom_color }}; --divider-color: {{ divider_color }}; --text-color: {{ text_color }}; --divider-height: {{ divider_height }}px; --text-size: {{ text_size }}px; --text-spacing: {{ text_spacing }}px;">
  
  <div class="scroll-text-divider-section">
    <svg class="scroll-divider-svg" viewBox="0 0 1440 120" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
      {% comment %} Divider shape {% endcomment %}
      {% case wave_style %}
        {% when 'subtle' %}
          <path id="divider-shape-{{ section.id }}" d="M0,0 L0,50 Q360,60 720,50 T1440,50 L1440,120 L0,120 Z" fill="var(--divider-color)"/>
          <path id="text-path-{{ section.id }}" d="M0,50 Q360,60 720,50 T1440,50" fill="none" stroke="none"/>
        {% when 'dramatic' %}
          <path id="divider-shape-{{ section.id }}" d="M0,0 L0,40 Q180,90 360,40 T720,50 T1080,40 T1440,75 L1440,120 L0,120 Z" fill="var(--divider-color)"/>
          <path id="text-path-{{ section.id }}" d="M0,40 Q180,90 360,40 T720,50 T1080,40 T1440,75" fill="none" stroke="none"/>
        {% when 'organic' %}
          <path id="divider-shape-{{ section.id }}" d="M0,0 L0,55 Q120,75 240,50 T480,48 T720,45 T960,50 T1200,52 L1440,52 L1440,120 L0,120 Z" fill="var(--divider-color)"/>
          <path id="text-path-{{ section.id }}" d="M0,55 Q120,75 240,50 T480,48 T720,45 T960,50 T1200,52 L1440,52" fill="none" stroke="none"/>
        {% else %}
          <path id="divider-shape-{{ section.id }}" d="M0,0 L0,60 Q360,80 720,50 T1440,50 L1440,120 L0,120 Z" fill="var(--divider-color)"/>
          <path id="text-path-{{ section.id }}" d="M0,60 Q360,80 720,50 T1440,50" fill="none" stroke="none"/>
      {% endcase %}
      
      {% comment %} Text following the wave path {% endcomment %}
      <text class="scroll-text-path" data-direction="{{ animation_direction }}" data-enable-animation="{{ enable_animation }}" dy="0">
        <textPath href="#text-path-{{ section.id }}" startOffset="0" method="align" spacing="auto">
          {% assign full_text = text_content %}
          {% comment %} Repeat text multiple times to fill entire path {% endcomment %}
          {% for i in (1..repeat_count) %}
            {{ full_text }} • 
          {% endfor %}
          {% for i in (1..repeat_count) %}
            {{ full_text }} • 
          {% endfor %}
          {% for i in (1..repeat_count) %}
            {{ full_text }} • 
          {% endfor %}
        </textPath>
      </text>
    </svg>
  </div>
</div>

<style>
  .scroll-text-divider-wrapper {
    position: relative;
    width: 100%;
    height: var(--divider-height);
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: var(--top-color);
    line-height: 0;
  }
  
  .scroll-text-divider-section {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }
  
  .scroll-divider-svg {
    width: 100%;
    height: 100%;
    display: block;
    position: relative;
    z-index: 1;
  }
  
  .scroll-text-path {
    font-size: var(--text-size);
    fill: var(--text-color);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    dominant-baseline: middle;
    text-anchor: start;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    text-rendering: geometricPrecision;
    shape-rendering: geometricPrecision;
  }
  
  .scroll-text-path textPath {
    letter-spacing: 0.05em;
  }
  
  /* CSS animation only when scroll animation is disabled */
  .scroll-text-path[data-enable-animation="false"][data-direction="right"] textPath {
    animation: scrollTextPathRight 20s linear infinite;
  }
  
  .scroll-text-path[data-enable-animation="false"][data-direction="left"] textPath {
    animation: scrollTextPathLeft 20s linear infinite;
  }
  
  @keyframes scrollTextPathRight {
    0% {
      startOffset: 0%;
    }
    100% {
      startOffset: 100%;
    }
  }
  
  @keyframes scrollTextPathLeft {
    0% {
      startOffset: 100%;
    }
    100% {
      startOffset: 0%;
    }
  }
  
  /* No CSS animation when scroll animation is enabled - GSAP will handle it */
  .scroll-text-path[data-enable-animation="true"] textPath {
    animation: none !important;
  }
  
  /* Responsive text size */
  @media screen and (max-width: 768px) {
    .scroll-text-path {
      font-size: calc(var(--text-size) * 0.7);
    }
  }
</style>

{% if enable_animation %}
  <script>
    (function() {
      'use strict';
      
      var sectionId = 'scroll-text-divider-{{ section.id }}';
      
      function loadGSAP(callback) {
        if (typeof gsap !== 'undefined') {
          callback();
          return;
        }
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js';
        script.async = true;
        script.onload = function() {
          loadScrollTrigger(callback);
        };
        document.head.appendChild(script);
      }
      
      function loadScrollTrigger(callback) {
        if (typeof ScrollTrigger !== 'undefined') {
          if (typeof gsap !== 'undefined' && typeof gsap.registerPlugin === 'function') {
            gsap.registerPlugin(ScrollTrigger);
          }
          callback();
          return;
        }
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/ScrollTrigger.min.js';
        script.async = true;
        script.onload = function() {
          if (typeof gsap !== 'undefined' && typeof ScrollTrigger !== 'undefined' && typeof gsap.registerPlugin === 'function') {
            gsap.registerPlugin(ScrollTrigger);
          }
          callback();
        };
        document.head.appendChild(script);
      }
      
      function setupScrollAnimation(textPath, speed, direction) {
        if (typeof gsap === 'undefined' || typeof ScrollTrigger === 'undefined') return;
        
        var wrapper = textPath.closest('.scroll-text-divider-wrapper');
        if (!wrapper) return;
        
        // Get the textPath element
        var pathElement = textPath.querySelector('textPath');
        if (!pathElement) return;
        
        // Get the actual path length to calculate proper offset
        var svgPath = document.querySelector(pathElement.getAttribute('href'));
        if (!svgPath) return;
        
        var pathLength = svgPath.getTotalLength();
        var textLength = pathElement.getComputedTextLength();
        
        // Calculate how many times we need to repeat to fill the path
        // We want the text to loop seamlessly
        var repeatNeeded = Math.ceil(pathLength / textLength) + 2;
        
        // Set initial position based on direction
        // For seamless loop, we need to account for the text length
        var startOffset = direction === 'right' ? 0 : pathLength;
        var endOffset = direction === 'right' ? pathLength : 0;
        
        // Set initial position (use pixel values for smoother animation)
        pathElement.setAttribute('startOffset', startOffset);
        
        // Create scroll-triggered animation - text moves along the path
        // scrub: true means it's directly tied to scroll position
        var scrollAnimation = gsap.to(pathElement, {
          attr: { startOffset: endOffset },
          ease: 'none',
          scrollTrigger: {
            trigger: wrapper,
            start: 'top bottom',
            end: 'bottom top',
            scrub: true, // Directly tied to scroll - no auto movement
            invalidateOnRefresh: true,
            onUpdate: function(self) {
              // For seamless looping, wrap the offset when it exceeds path length
              var currentOffset = parseFloat(pathElement.getAttribute('startOffset')) || 0;
              if (direction === 'right') {
                // Loop seamlessly when text goes beyond path length
                while (currentOffset >= pathLength) {
                  currentOffset = currentOffset - pathLength;
                }
                pathElement.setAttribute('startOffset', currentOffset);
              } else {
                // Loop seamlessly when text goes before start
                while (currentOffset <= -pathLength) {
                  currentOffset = currentOffset + pathLength;
                }
                pathElement.setAttribute('startOffset', currentOffset);
              }
            }
          }
        });
        
        // Text now moves along the wave path ONLY based on scroll position
        // No auto-scroll or loop animation
      }
      
      function initScrollTextAnimation() {
        var wrapper = document.getElementById(sectionId);
        if (!wrapper) return;
        
        var enableAnimation = wrapper.dataset.enableAnimation === 'true';
        var scrollSpeed = parseFloat(wrapper.dataset.scrollSpeed) || 1;
        var direction = wrapper.dataset.animationDirection || 'right';
        var textPath = wrapper.querySelector('.scroll-text-path');
        
        if (!textPath || !enableAnimation) return;
        
        // Load GSAP and ScrollTrigger
        loadGSAP(function() {
          setupScrollAnimation(textPath, scrollSpeed, direction);
        });
      }
      
      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initScrollTextAnimation);
      } else {
        setTimeout(initScrollTextAnimation, 100);
      }
    })();
  </script>
{% endif %}

{% schema %}
{
  "name": "Scroll Text Divider",
  "settings": [
    {
      "type": "header",
      "content": "Text Content"
    },
    {
      "type": "text",
      "id": "text_content",
      "label": "Text content",
      "default": "A) - IT'S A MATCH(A) - IT",
      "info": "Text that will scroll along the divider"
    },
    {
      "type": "range",
      "id": "repeat_count",
      "label": "Text repeat count",
      "min": 4,
      "max": 20,
      "step": 2,
      "default": 8,
      "info": "How many times to repeat the text for seamless scrolling (higher = more coverage)"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "top_color",
      "label": "Top section color",
      "default": "#E8F5E9",
      "info": "Background color above the divider"
    },
    {
      "type": "color",
      "id": "bottom_color",
      "label": "Bottom section color",
      "default": "#F1F8E9",
      "info": "Background color below the divider"
    },
    {
      "type": "color",
      "id": "divider_color",
      "label": "Divider color",
      "default": "#2E7D32",
      "info": "Color of the curved divider shape"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#A5D6A7",
      "info": "Color of the scrolling text"
    },
    {
      "type": "header",
      "content": "Typography"
    },
    {
      "type": "range",
      "id": "text_size",
      "label": "Text size",
      "min": 12,
      "max": 60,
      "step": 2,
      "default": 24,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "text_spacing",
      "label": "Text spacing",
      "min": 20,
      "max": 100,
      "step": 5,
      "default": 50,
      "unit": "px",
      "info": "Space between repeated text items"
    },
    {
      "type": "header",
      "content": "Size"
    },
    {
      "type": "range",
      "id": "divider_height",
      "label": "Divider height",
      "min": 80,
      "max": 300,
      "step": 10,
      "default": 120,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Animation"
    },
    {
      "type": "checkbox",
      "id": "enable_animation",
      "label": "Enable scroll animation",
      "default": true,
      "info": "Text moves as you scroll the page"
    },
    {
      "type": "select",
      "id": "animation_direction",
      "label": "Animation direction",
      "default": "right",
      "options": [
        {
          "value": "right",
          "label": "Right (text moves left to right)"
        },
        {
          "value": "left",
          "label": "Left (text moves right to left)"
        }
      ],
      "info": "Direction of text movement"
    },
    {
      "type": "range",
      "id": "scroll_speed",
      "label": "Scroll speed",
      "min": 0.5,
      "max": 3,
      "step": 0.1,
      "default": 1,
      "info": "Speed multiplier for scroll animation (1 = normal speed)"
    },
    {
      "type": "header",
      "content": "Wave Style"
    },
    {
      "type": "select",
      "id": "wave_style",
      "label": "Wave intensity",
      "default": "medium",
      "options": [
        {
          "value": "subtle",
          "label": "Subtle"
        },
        {
          "value": "medium",
          "label": "Medium"
        },
        {
          "value": "dramatic",
          "label": "Dramatic"
        },
        {
          "value": "organic",
          "label": "Organic"
        }
      ],
      "info": "Shape of the curved divider"
    }
  ],
  "presets": [
    {
      "name": "Scroll Text Divider"
    }
  ]
}
{% endschema %}

